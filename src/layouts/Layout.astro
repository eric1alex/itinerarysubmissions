---
import { getUserFromRequest } from "../lib/auth";

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Share and discover amazing travel itineraries" } =
  Astro.props;

// Check if user is logged in
const user = getUserFromRequest(Astro.request);
---

<!doctype html>
<html class="light" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title}</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />
    <script
      is:inline
      src="https://cdn.tailwindcss.com?plugins=forms,container-queries"
    ></script>
    <style>
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
    </style>
    <script is:inline id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#3A86FF",
              secondary: "#FFBE0B",
              "background-light": "#F8F9FA",
              "background-dark": "#101922",
              "text-light": "#333333",
              "text-dark": "#E9ECEF",
              "border-light": "#E9ECEF",
              "border-dark": "#343a40",
            },
            fontFamily: {
              display: ["Plus Jakarta Sans", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="font-display bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark"
  >
    <div
      class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden"
    >
      <!-- TopNavBar -->
      <header
        class="sticky top-0 z-10 flex items-center justify-center whitespace-nowrap border-b border-solid border-border-light dark:border-border-dark bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm"
      >
        <div
          class="flex items-center justify-between w-full max-w-7xl px-4 sm:px-6 lg:px-8 py-3"
        >
          <a
            href="/itineraries"
            class="flex items-center gap-4 text-text-light dark:text-text-dark"
          >
            <div class="size-6 text-primary">
              <svg
                fill="none"
                viewBox="0 0 48 48"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M44 11.2727C44 14.0109 39.8386 16.3957 33.69 17.6364C39.8386 18.877 44 21.2618 44 24C44 26.7382 39.8386 29.123 33.69 30.3636C39.8386 31.6043 44 33.9891 44 36.7273C44 40.7439 35.0457 44 24 44C12.9543 44 4 40.7439 4 36.7273C4 33.9891 8.16144 31.6043 14.31 30.3636C8.16144 29.123 4 26.7382 4 24C4 21.2618 8.16144 18.877 14.31 17.6364C8.16144 16.3957 4 14.0109 4 11.2727C4 7.25611 12.9543 4 24 4C35.0457 4 44 7.25611 44 11.2727Z"
                  fill="currentColor"></path>
              </svg>
            </div>
            <h2 class="text-xl font-bold leading-tight tracking-[-0.015em]">
              Where In India
            </h2>
          </a>
          <div class="flex items-center gap-6">
            <a
              class="text-sm font-medium leading-normal hover:text-primary dark:hover:text-primary"
              href="/itineraries">Itineraries</a
            >
            
            {user ? (
              <!-- Logged In: Profile Menu -->
              <div class="relative">
                <button
                  id="profile-btn"
                  class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                >
                  <div
                    class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8"
                    style={`background-image: url("https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}&background=3A86FF&color=fff");`}
                  >
                  </div>
                  <span class="material-symbols-outlined text-lg">expand_more</span>
                </button>
                
                <div
                  id="profile-menu"
                  class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-border-light dark:border-border-dark py-2 z-50"
                >
                  <div class="px-4 py-3 border-b border-border-light dark:border-border-dark">
                    <p class="text-sm font-medium text-gray-900 dark:text-white truncate">{user.email}</p>
                  </div>
                  
                  <a
                    href="/my-itineraries"
                    class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >
                    <span class="material-symbols-outlined text-xl">map</span>
                    <span>My Itineraries</span>
                  </a>
                  
                  <button
                    id="delete-account-btn"
                    class="w-full flex items-center gap-3 px-4 py-3 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20"
                  >
                    <span class="material-symbols-outlined text-xl">delete_forever</span>
                    <span>Delete Account</span>
                  </button>
                  
                  <div class="border-t border-border-light dark:border-border-dark my-2"></div>
                  
                  <button
                    id="logout-btn"
                    class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >
                    <span class="material-symbols-outlined text-xl">logout</span>
                    <span>Log Out</span>
                  </button>
                </div>
              </div>
            ) : (
              <!-- Logged Out: Login Button -->
              <a
                href="/login"
                class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors"
              >
                <span class="material-symbols-outlined text-lg">login</span>
                <span>Login</span>
              </a>
            )}
          </div>
        </div>
      </header>

      <!-- Main Content Slot -->
      <slot />

      <!-- Footer -->
      <footer
        class="w-full bg-white dark:bg-background-dark/50 border-t border-border-light dark:border-border-dark mt-auto"
      >
        <div
          class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500 dark:text-gray-400"
        >
          <p>Â© 2024 Where In India. All rights reserved.</p>
          <div class="flex justify-center gap-4 mt-2">
            <a class="hover:text-primary" href="/about">About Us</a>
            <a class="hover:text-primary" href="/contact">Contact</a>
            <a class="hover:text-primary" href="/terms">Terms of Service</a>
          </div>
        </div>
      </footer>
    </div>
    
    <script>
      // Profile menu toggle
      const profileBtn = document.getElementById('profile-btn');
      const profileMenu = document.getElementById('profile-menu');
      const logoutBtn = document.getElementById('logout-btn');
      const deleteAccountBtn = document.getElementById('delete-account-btn');
      
      if (profileBtn && profileMenu) {
        profileBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          profileMenu.classList.toggle('hidden');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', () => {
          profileMenu.classList.add('hidden');
        });
        
        profileMenu.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
      
      // Logout
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          try {
            await fetch('/api/auth/logout.json', { method: 'POST' });
            window.location.href = '/';
          } catch (error) {
            alert('Failed to log out');
          }
        });
      }
      
      // Delete account
      if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', async () => {
          const confirmed = confirm(
            'Are you sure you want to delete your account? This will permanently delete all your itineraries and cannot be undone.'
          );
          
          if (!confirmed) return;
          
          try {
            const response = await fetch('/api/auth/delete-account.json', { method: 'POST' });
            const result = await response.json();
            
            if (result.success) {
              alert('Your account has been deleted.');
              window.location.href = '/';
            } else {
              alert(result.message || 'Failed to delete account');
            }
          } catch (error) {
            alert('An error occurred');
          }
        });
      }
    </script>
  </body>
</html>
