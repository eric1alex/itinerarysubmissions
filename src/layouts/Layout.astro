---
import { getUserFromRequest } from "../lib/auth";

interface Props {
  title: string;
  description?: string;
}

const { title, description = "Share and discover amazing travel itineraries" } =
  Astro.props;

// Check if user is logged in
const user = getUserFromRequest(Astro.request);
---

<!doctype html>
<html class="light" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <title>{title}</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />
    <script
      is:inline
      src="https://cdn.tailwindcss.com?plugins=forms,container-queries"
    ></script>
    <style>
      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 400,
          "GRAD" 0,
          "opsz" 24;
      }
    </style>
    <script is:inline id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "var(--primary-color)",
              secondary: "#FFBE0B",
              "background-light": "#F8F9FA",
              "background-dark": "#1a1a1a",
              "text-light": "#333333",
              "text-dark": "#E9ECEF",
              "border-light": "#E9ECEF",
              "border-dark": "#343a40",
            },
            fontFamily: {
              display: ["Plus Jakarta Sans", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      :root {
        --primary-color: #3A86FF;
      }
      html.dark {
        --primary-color: #FF671F;
      }
    </style>
    <script is:inline>
      (function() {
        const theme = localStorage.getItem('theme') || 'light';
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
          document.documentElement.classList.remove('light');
        } else {
          document.documentElement.classList.add('light');
          document.documentElement.classList.remove('dark');
        }
      })();
    </script>
  </head>
  <body
    class="font-display bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark"
  >
    <div
      class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden"
    >
      <!-- TopNavBar -->
      <header
        class="sticky top-0 z-10 flex items-center justify-center whitespace-nowrap border-b border-solid border-border-light dark:border-border-dark bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm"
      >
        <div
          class="flex items-center justify-between w-full max-w-7xl px-4 sm:px-6 lg:px-8 py-3"
        >
          <a
            href="/itineraries"
            class="flex items-center gap-3 text-text-light dark:text-text-dark"
          >
            <img src="/flag.png" alt="Where In India" class="h-8 w-auto" />
            <h2 class="text-xl font-bold leading-tight tracking-[-0.015em]">
              Where In India
            </h2>
          </a>
          <div class="flex items-center gap-4">
            <!-- Desktop Theme Toggle -->
            <button
              id="theme-toggle-desktop"
              class="hidden sm:flex items-center justify-center size-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
              title="Toggle theme"
            >
              <span class="material-symbols-outlined text-xl text-gray-600 dark:text-gray-300 dark:hidden">dark_mode</span>
              <span class="material-symbols-outlined text-xl text-gray-600 dark:text-gray-300 hidden dark:inline">light_mode</span>
            </button>
            {user ? (
              <!-- Logged In: Profile Menu -->
              <div class="relative">
                <button
                  id="profile-btn"
                  class="flex items-center justify-center size-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                  title="Account menu"
                >
                  <span class="material-symbols-outlined text-2xl text-gray-600 dark:text-gray-300">account_circle</span>
                </button>
                
                <div
                  id="profile-menu"
                  class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-neutral-800 rounded-lg shadow-xl border border-border-light dark:border-neutral-700 py-2 z-50"
                >
                  <div class="px-4 py-3 border-b border-border-light dark:border-border-dark">
                    <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                      {user.displayName || user.email}
                    </p>
                    {user.displayName && (
                      <p class="text-xs text-gray-500 dark:text-gray-400 truncate mt-0.5">{user.email}</p>
                    )}
                  </div>
                  
                  <a
                    href="/account-settings"
                    class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-neutral-700"
                  >
                    <span class="material-symbols-outlined text-xl">settings</span>
                    <span>Account Settings</span>
                  </a>
                  
                  <a
                    href="/my-itineraries"
                    class="flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-neutral-700"
                  >
                    <span class="material-symbols-outlined text-xl">map</span>
                    <span>My Itineraries</span>
                  </a>
                  
                  <!-- Mobile Theme Toggle -->
                  <button
                    id="theme-toggle-mobile"
                    class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-neutral-700 sm:hidden"
                  >
                    <span class="material-symbols-outlined text-xl dark:hidden">dark_mode</span>
                    <span class="material-symbols-outlined text-xl hidden dark:inline">light_mode</span>
                    <span class="dark:hidden">Dark Mode</span>
                    <span class="hidden dark:inline">Light Mode</span>
                  </button>
                  
                  <div class="border-t border-border-light dark:border-border-dark my-2"></div>
                  
                  <button
                    id="delete-account-btn"
                    class="w-full flex items-center gap-3 px-4 py-3 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20"
                  >
                    <span class="material-symbols-outlined text-xl">delete_forever</span>
                    <span>Delete Account</span>
                  </button>
                </div>
              </div>
            ) : (
              <!-- Logged Out: Theme Toggle + Person Icon -->
              <button
                id="theme-toggle-mobile-guest"
                class="flex sm:hidden items-center justify-center size-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                title="Toggle theme"
              >
                <span class="material-symbols-outlined text-xl text-gray-600 dark:text-gray-300 dark:hidden">dark_mode</span>
                <span class="material-symbols-outlined text-xl text-gray-600 dark:text-gray-300 hidden dark:inline">light_mode</span>
              </button>
              <a
                href="/login"
                class="flex items-center justify-center size-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                title="Sign in"
              >
                <span class="material-symbols-outlined text-2xl text-gray-600 dark:text-gray-300">account_circle</span>
              </a>
            )}
          </div>
        </div>
      </header>

      <!-- Main Content Slot -->
      <slot />

      <!-- Footer -->
      <footer
        class="w-full bg-white dark:bg-background-dark/50 border-t border-border-light dark:border-border-dark mt-auto"
      >
        <div
          class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500 dark:text-gray-400"
        >
          <p>Â© 2024 Where In India. All rights reserved.</p>
          <div class="flex justify-center gap-4 mt-2">
            <a class="hover:text-primary" href="/about">About Us</a>
            <a class="hover:text-primary" href="/contact">Contact</a>
            <a class="hover:text-primary" href="/terms">Terms of Service</a>
          </div>
        </div>
      </footer>
    </div>
    
    <script>
      // Theme toggle function
      function toggleTheme() {
        const isDark = document.documentElement.classList.contains('dark');
        if (isDark) {
          document.documentElement.classList.remove('dark');
          document.documentElement.classList.add('light');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.classList.remove('light');
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
      }
      
      // Desktop theme toggle
      const themeToggleDesktop = document.getElementById('theme-toggle-desktop');
      if (themeToggleDesktop) {
        themeToggleDesktop.addEventListener('click', toggleTheme);
      }
      
      // Mobile theme toggle (logged in)
      const themeToggleMobile = document.getElementById('theme-toggle-mobile');
      if (themeToggleMobile) {
        themeToggleMobile.addEventListener('click', toggleTheme);
      }
      
      // Mobile theme toggle (guest/logged out)
      const themeToggleMobileGuest = document.getElementById('theme-toggle-mobile-guest');
      if (themeToggleMobileGuest) {
        themeToggleMobileGuest.addEventListener('click', toggleTheme);
      }
      
      // Profile menu toggle
      const profileBtn = document.getElementById('profile-btn');
      const profileMenu = document.getElementById('profile-menu');
      const deleteAccountBtn = document.getElementById('delete-account-btn');
      
      if (profileBtn && profileMenu) {
        profileBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          profileMenu.classList.toggle('hidden');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', () => {
          profileMenu.classList.add('hidden');
        });
        
        profileMenu.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
      
      // Delete account
      if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', async () => {
          const confirmed = confirm(
            'Are you sure you want to delete your account? This will permanently delete all your itineraries and cannot be undone.'
          );
          
          if (!confirmed) return;
          
          try {
            const response = await fetch('/api/auth/delete-account.json', { method: 'POST' });
            const result = await response.json();
            
            if (result.success) {
              alert('Your account has been deleted.');
              window.location.href = '/';
            } else {
              alert(result.message || 'Failed to delete account');
            }
          } catch (error) {
            alert('An error occurred');
          }
        });
      }
    </script>
  </body>
</html>
