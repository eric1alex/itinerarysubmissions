---
import Layout from "../layouts/Layout.astro";
import { getUserFromRequest } from "../lib/auth";
import { db, User, eq } from "astro:db";

export const prerender = false;

// Check if user is logged in
const user = getUserFromRequest(Astro.request);

if (!user) {
    return Astro.redirect("/login");
}

// Get full user data from database
const users = await db.select().from(User).where(eq(User.id, user.userId));

const userData = users[0];
---

<Layout title="Account Settings - Where In India">
    <main class="flex-1 py-8 px-4 sm:px-6 lg:px-8">
        <div class="max-w-2xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-8">
                Account Settings
            </h1>

            <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-border-light dark:border-border-dark p-6"
            >
                <!-- Profile Section -->
                <div class="mb-6">
                    <h2
                        class="text-lg font-semibold text-gray-900 dark:text-white mb-4"
                    >
                        Profile Information
                    </h2>

                    <form id="profile-form" class="space-y-4">
                        <!-- Display Name -->
                        <div>
                            <label
                                for="displayName"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                            >
                                Display Name
                            </label>
                            <input
                                type="text"
                                id="displayName"
                                name="displayName"
                                value={userData?.displayName || ""}
                                placeholder="Enter your display name"
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-primary focus:border-transparent"
                            />
                            <p
                                class="mt-1 text-sm text-gray-500 dark:text-gray-400"
                            >
                                This name will be displayed instead of your
                                email
                            </p>
                        </div>

                        <!-- Email (read-only) -->
                        <div>
                            <label
                                for="email"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                            >
                                Email Address
                            </label>
                            <input
                                type="email"
                                id="email"
                                value={user.email}
                                disabled
                                class="w-full px-4 py-2 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 cursor-not-allowed"
                            />
                            <p
                                class="mt-1 text-sm text-gray-500 dark:text-gray-400"
                            >
                                Email cannot be changed
                            </p>
                        </div>

                        <!-- Submit Button -->
                        <div class="pt-4">
                            <button
                                type="submit"
                                class="w-full sm:w-auto px-6 py-2.5 bg-primary text-white font-medium rounded-lg hover:bg-primary/90 transition-colors focus:ring-2 focus:ring-primary focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Save Changes
                            </button>
                        </div>
                    </form>

                    <!-- Success/Error Messages -->
                    <div id="message" class="hidden mt-4 p-4 rounded-lg"></div>
                </div>

                <!-- Divider -->
                <hr class="border-border-light dark:border-border-dark my-6" />

                <!-- Danger Zone -->
                <div>
                    <h2
                        class="text-lg font-semibold text-red-600 dark:text-red-400 mb-4"
                    >
                        Danger Zone
                    </h2>

                    <div
                        class="p-4 border border-red-200 dark:border-red-900 rounded-lg bg-red-50 dark:bg-red-900/20"
                    >
                        <h3
                            class="font-medium text-gray-900 dark:text-white mb-1"
                        >
                            Delete Account
                        </h3>
                        <p
                            class="text-sm text-gray-600 dark:text-gray-400 mb-4"
                        >
                            Once you delete your account, there is no going
                            back. All your itineraries will be permanently
                            deleted.
                        </p>
                        <button
                            id="delete-account-btn"
                            class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-colors focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                        >
                            Delete Account
                        </button>
                    </div>
                </div>
            </div>

            <!-- Back Link -->
            <div class="mt-6">
                <a
                    href="/"
                    class="text-primary hover:underline flex items-center gap-1"
                >
                    <span class="material-symbols-outlined text-lg"
                        >arrow_back</span
                    >
                    Back to Home
                </a>
            </div>
        </div>
    </main>

    <script>
        const form = document.getElementById("profile-form") as HTMLFormElement;
        const messageDiv = document.getElementById("message") as HTMLDivElement;
        const deleteBtn = document.getElementById(
            "delete-account-btn",
        ) as HTMLButtonElement;

        function showMessage(text: string, isError: boolean) {
            messageDiv.textContent = text;
            messageDiv.className = `mt-4 p-4 rounded-lg ${
                isError
                    ? "bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800"
                    : "bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 border border-green-200 dark:border-green-800"
            }`;
            messageDiv.classList.remove("hidden");

            // Hide after 5 seconds
            setTimeout(() => {
                messageDiv.classList.add("hidden");
            }, 5000);
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const submitBtn = form.querySelector(
                'button[type="submit"]',
            ) as HTMLButtonElement;
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = "Saving...";

            try {
                const displayName = (
                    document.getElementById("displayName") as HTMLInputElement
                ).value;

                const response = await fetch("/api/auth/update-profile.json", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ displayName }),
                });

                const result = await response.json();

                if (result.success) {
                    showMessage("Profile updated successfully!", false);
                } else {
                    showMessage(
                        result.message || "Failed to update profile",
                        true,
                    );
                }
            } catch (error) {
                showMessage("An error occurred", true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Delete account
        deleteBtn.addEventListener("click", async () => {
            const confirmed = confirm(
                "Are you sure you want to delete your account? This will permanently delete all your itineraries and cannot be undone.",
            );

            if (!confirmed) return;

            try {
                const response = await fetch("/api/auth/delete-account.json", {
                    method: "POST",
                });
                const result = await response.json();

                if (result.success) {
                    alert("Your account has been deleted.");
                    window.location.href = "/";
                } else {
                    showMessage(
                        result.message || "Failed to delete account",
                        true,
                    );
                }
            } catch (error) {
                showMessage("An error occurred", true);
            }
        });
    </script>
</Layout>
