---
import Layout from "../../layouts/Layout.astro";
import { db, Itinerary, User, eq } from "astro:db";
import { getUserFromRequest } from "../../lib/auth";

export const prerender = false;

const { id } = Astro.params;
const currentUser = getUserFromRequest(Astro.request);

const itineraries = await db
    .select({
        itinerary: Itinerary,
        authorEmail: User.email,
        authorDisplayName: User.displayName,
    })
    .from(Itinerary)
    .innerJoin(User, eq(Itinerary.userId, User.id))
    .where(eq(Itinerary.id, id || ""));

if (itineraries.length === 0) {
    return Astro.redirect("/itineraries");
}

const { itinerary, authorEmail, authorDisplayName } = itineraries[0];
const isOwner = currentUser && currentUser.userId === itinerary.userId;

// Use display name if available, otherwise use email username
const authorName = authorDisplayName || authorEmail.split("@")[0];

const formatDate = (dateStr: string) => {
    return new Date(dateStr).toLocaleDateString("en-IN", {
        year: "numeric",
        month: "short",
        day: "numeric",
    });
};
---

<Layout title={`${itinerary.title} - Where In India`}>
    <main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="flex flex-wrap justify-between items-start gap-4">
                    <div class="flex flex-col gap-2">
                        <p
                            class="text-3xl md:text-4xl font-black leading-tight tracking-[-0.033em] text-text-light dark:text-text-dark"
                        >
                            {itinerary.title}
                        </p>
                        <p class="text-gray-500 dark:text-gray-400 text-base">
                            By {authorName} | {formatDate(itinerary.startDate)} -
                            {formatDate(itinerary.endDate)} | {
                                itinerary.fromLocation
                            } â†’ {itinerary.toLocation}
                        </p>
                    </div>
                    <div class="flex lg:hidden gap-2">
                        <button
                            id="download-btn-mobile"
                            class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold gap-2"
                        >
                            <span class="material-symbols-outlined text-lg"
                                >download</span
                            >
                            <span>Download</span>
                        </button>
                        {
                            isOwner && (
                                <a
                                    href={`/submit?id=${itinerary.id}`}
                                    class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-gray-200 dark:bg-white/10 text-text-light dark:text-text-dark text-sm font-bold"
                                >
                                    Edit
                                </a>
                            )
                        }
                    </div>
                </div>

                <p
                    class="text-base text-gray-600 dark:text-gray-300 whitespace-pre-line"
                >
                    {itinerary.summary}
                </p>

                <div class="space-y-4">
                    {
                        itinerary.days.map((day: any, index: number) => (
                            <div class="rounded-xl border border-border-light dark:border-border-dark bg-white dark:bg-background-dark/50">
                                <details class="group p-4" open={index === 0}>
                                    <summary class="flex cursor-pointer items-center justify-between gap-4">
                                        <h3 class="text-lg font-bold text-text-light dark:text-text-dark">
                                            Day {day.dayNumber}: {day.title}
                                        </h3>
                                        <span class="material-symbols-outlined transition-transform duration-300 group-open:rotate-180">
                                            expand_more
                                        </span>
                                    </summary>
                                    <div class="mt-4 space-y-4 text-gray-600 dark:text-gray-400">
                                        {day.activities.map((activity: any) => (
                                            <div class="p-4 rounded-lg bg-background-light dark:bg-background-dark">
                                                <h4 class="font-bold text-text-light dark:text-text-dark">
                                                    {activity.title}
                                                </h4>
                                                <p class="text-sm whitespace-pre-line">
                                                    {activity.description}
                                                </p>
                                                {(activity.time ||
                                                    activity.address) && (
                                                    <p class="text-sm mt-1 text-gray-500">
                                                        {activity.time &&
                                                            `Time: ${activity.time}`}
                                                        {activity.time &&
                                                            activity.address &&
                                                            " | "}
                                                        {activity.address &&
                                                            `Address: ${activity.address}`}
                                                    </p>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </details>
                            </div>
                        ))
                    }
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                <div class="sticky top-24 space-y-6">
                    <div
                        class="hidden lg:block bg-white dark:bg-background-dark/50 p-4 rounded-xl border border-border-light dark:border-border-dark"
                    >
                        <div class="flex flex-col gap-3">
                            <button
                                id="download-btn"
                                class="flex w-full cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-primary text-white gap-2 text-sm font-bold"
                            >
                                <span class="material-symbols-outlined text-xl"
                                    >download</span
                                >
                                <span>Download</span>
                            </button>
                            <button
                                id="copy-btn"
                                class="flex w-full cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-gray-200 dark:bg-white/10 text-text-light dark:text-text-dark text-sm font-bold"
                                >Copy Itinerary</button
                            >
                            {
                                isOwner && (
                                    <a
                                        href={`/submit?id=${itinerary.id}`}
                                        class="flex w-full cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-transparent text-text-light dark:text-text-dark gap-2 text-sm font-bold"
                                    >
                                        <span class="material-symbols-outlined text-xl">
                                            edit
                                        </span>
                                        <span>Edit</span>
                                    </a>
                                )
                            }
                        </div>
                    </div>

                    <div
                        class="bg-white dark:bg-background-dark/50 p-4 rounded-xl border border-border-light dark:border-border-dark"
                    >
                        <div class="grid grid-cols-1">
                            <div
                                class="grid grid-cols-2 py-4 border-b border-b-border-light dark:border-b-border-dark"
                            >
                                <p
                                    class="text-gray-500 dark:text-gray-400 text-sm"
                                >
                                    Duration
                                </p>
                                <p
                                    class="text-text-light dark:text-text-dark text-sm font-medium"
                                >
                                    {itinerary.duration}
                                </p>
                            </div>
                            {
                                itinerary.tripType && (
                                    <div class="grid grid-cols-2 py-4 border-b border-b-border-light dark:border-b-border-dark">
                                        <p class="text-gray-500 dark:text-gray-400 text-sm">
                                            Trip Type
                                        </p>
                                        <p class="text-text-light dark:text-text-dark text-sm font-medium">
                                            {itinerary.tripType}
                                        </p>
                                    </div>
                                )
                            }
                            {
                                itinerary.budget && (
                                    <div class="grid grid-cols-2 py-4 border-b border-b-border-light dark:border-b-border-dark">
                                        <p class="text-gray-500 dark:text-gray-400 text-sm">
                                            Budget
                                        </p>
                                        <p class="text-text-light dark:text-text-dark text-sm font-medium">
                                            {itinerary.budget}
                                        </p>
                                    </div>
                                )
                            }
                            {
                                itinerary.transport && (
                                    <div class="grid grid-cols-2 py-4">
                                        <p class="text-gray-500 dark:text-gray-400 text-sm">
                                            Transport
                                        </p>
                                        <p class="text-text-light dark:text-text-dark text-sm font-medium">
                                            {itinerary.transport}
                                        </p>
                                    </div>
                                )
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script
    src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
></script>

<script define:vars={{ itineraryData: itinerary }}>
    function showToast(message, type) {
        const toast = document.createElement("div");
        const colors = {
            success: "bg-green-500",
            error: "bg-red-500",
            info: "bg-primary",
        };
        toast.className =
            "fixed bottom-4 right-4 " +
            (colors[type] || colors.info) +
            " text-white px-6 py-3 rounded-lg shadow-lg z-50";
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(function () {
            toast.style.opacity = "0";
            setTimeout(function () {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

    function handleDownload() {
        var jsPDF = window.jspdf.jsPDF;
        var doc = new jsPDF();

        var pageWidth = doc.internal.pageSize.getWidth();
        var pageHeight = doc.internal.pageSize.getHeight();
        var margin = 15;
        var contentWidth = pageWidth - margin * 2;
        var y = 15;

        // Header
        doc.setFont("helvetica", "bold");
        doc.setFontSize(9);
        doc.setTextColor(74, 144, 226);
        doc.text("WHERE IN INDIA", margin, y);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(100);
        doc.textWithLink("whereinindia.in", pageWidth - margin - 25, y, {
            url: "https://whereinindia.in",
        });
        y += 4;
        doc.setDrawColor(220);
        doc.line(margin, y, pageWidth - margin, y);
        y += 8;

        // Title
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.setTextColor(20);
        doc.text(itineraryData.title, margin, y);
        y += 6;

        // Route + Meta
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor(80);
        var meta =
            itineraryData.fromLocation +
            " to " +
            itineraryData.toLocation +
            "  |  " +
            itineraryData.duration;
        if (itineraryData.transport) meta += "  |  " + itineraryData.transport;
        doc.text(meta, margin, y);
        y += 6;

        // Summary
        doc.setFontSize(9);
        doc.setTextColor(60);
        var summaryLines = doc.splitTextToSize(
            itineraryData.summary,
            contentWidth,
        );
        doc.text(summaryLines.slice(0, 2), margin, y);
        y += Math.min(summaryLines.length, 2) * 4 + 4;

        // Separator
        doc.setDrawColor(230);
        doc.line(margin, y, pageWidth - margin, y);
        y += 6;

        // Days
        for (var d = 0; d < itineraryData.days.length; d++) {
            var day = itineraryData.days[d];
            if (y > 270) {
                doc.addPage();
                y = 15;
            }

            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.setTextColor(74, 144, 226);
            doc.text(
                "Day " + day.dayNumber + ": " + (day.title || ""),
                margin,
                y,
            );
            y += 5;

            for (var a = 0; a < day.activities.length; a++) {
                var activity = day.activities[a];
                if (y > 275) {
                    doc.addPage();
                    y = 15;
                }

                doc.setFont("helvetica", "bold");
                doc.setFontSize(9);
                doc.setTextColor(40);
                doc.text("- " + (activity.title || "Activity"), margin + 3, y);
                y += 4;

                if (activity.description) {
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(8);
                    doc.setTextColor(80);
                    var desc = doc.splitTextToSize(
                        activity.description,
                        contentWidth - 8,
                    );
                    doc.text(desc.slice(0, 2), margin + 6, y);
                    y += Math.min(desc.length, 2) * 3 + 1;
                }

                if (activity.time || activity.address) {
                    doc.setFontSize(7);
                    doc.setTextColor(120);
                    var info = "";
                    if (activity.time) info += activity.time;
                    if (activity.time && activity.address) info += " | ";
                    if (activity.address) info += activity.address;
                    doc.text(info, margin + 6, y);
                    y += 3;
                }
                y += 2;
            }
            y += 3;
        }

        // Footer
        doc.setFont("helvetica", "normal");
        doc.setFontSize(7);
        doc.setTextColor(150);
        doc.text("Generated from Where In India", margin, pageHeight - 10);

        doc.save(itineraryData.title.replace(/\s+/g, "-") + ".pdf");
        showToast("PDF downloaded!", "success");
    }

    function handleCopy() {
        var text =
            itineraryData.title + "\n\n" + itineraryData.summary + "\n\n";
        for (var d = 0; d < itineraryData.days.length; d++) {
            var day = itineraryData.days[d];
            text += "Day " + day.dayNumber + ": " + day.title + "\n";
            for (var a = 0; a < day.activities.length; a++) {
                var activity = day.activities[a];
                text += "  - " + activity.title + "\n";
                if (activity.description)
                    text += "    " + activity.description + "\n";
            }
            text += "\n";
        }
        text += "\nView full itinerary: " + window.location.href;

        navigator.clipboard
            .writeText(text)
            .then(function () {
                showToast("Itinerary copied to clipboard!", "success");
            })
            .catch(function () {
                showToast("Failed to copy", "error");
            });
    }

    document
        .getElementById("download-btn")
        ?.addEventListener("click", handleDownload);
    document
        .getElementById("download-btn-mobile")
        ?.addEventListener("click", handleDownload);
    document.getElementById("copy-btn")?.addEventListener("click", handleCopy);
</script>
