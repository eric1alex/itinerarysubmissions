---
import Layout from "../layouts/Layout.astro";
import VerificationModal from "../components/VerificationModal.astro";

// Check if we're editing an existing itinerary
const url = new URL(Astro.request.url);
const editId = url.searchParams.get("id");
---

<Layout title="Create Your Itinerary - Where In India">
    <main class="flex flex-1 justify-center py-10 px-4 sm:px-6 lg:px-8">
        <div class="layout-content-container flex flex-col w-full max-w-4xl">
            <form id="itinerary-form" class="flex flex-col gap-8">
                <div class="flex flex-col gap-3 p-4">
                    <h1
                        class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]"
                    >
                        {
                            editId
                                ? "Edit Your Itinerary"
                                : "Create Your Itinerary"
                        }
                    </h1>
                    <p
                        class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal"
                    >
                        Fill in the details below to share your travel plan with
                        the community.
                    </p>
                </div>

                <div class="flex flex-col gap-6 p-4">
                    <!-- Basic Info -->
                    <div class="flex w-full flex-col gap-4">
                        <label class="flex flex-col w-full">
                            <p
                                class="text-gray-900 dark:text-white text-base font-medium leading-normal pb-2"
                            >
                                Itinerary Title *
                            </p>
                            <input
                                id="title"
                                name="title"
                                required
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-500 dark:placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal"
                                placeholder="e.g., 10-Day Backpacking Trip in Rajasthan"
                            />
                        </label>

                        <label class="flex flex-col w-full">
                            <p
                                class="text-gray-900 dark:text-white text-base font-medium leading-normal pb-2"
                            >
                                Summary *
                            </p>
                            <textarea
                                id="summary"
                                name="summary"
                                required
                                rows="3"
                                class="form-textarea flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 placeholder:text-gray-500 dark:placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal"
                                placeholder="Brief description of your trip..."
                            ></textarea>
                        </label>
                    </div>

                    <!-- Author & Location -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="flex flex-col w-full">
                            <p
                                class="text-gray-900 dark:text-white text-base font-medium leading-normal pb-2"
                            >
                                Your Name *
                            </p>
                            <input
                                id="author"
                                name="author"
                                required
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-500 dark:placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal"
                                placeholder="e.g., Alex Doe"
                            />
                        </label>
                        <label class="flex flex-col w-full">
                            <p
                                class="text-gray-900 dark:text-white text-base font-medium leading-normal pb-2"
                            >
                                Location *
                            </p>
                            <input
                                id="location"
                                name="location"
                                required
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-500 dark:placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal"
                                placeholder="e.g., Rajasthan, India"
                            />
                        </label>
                    </div>

                    <!-- Dates -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="flex flex-col w-full">
                            <p
                                class="text-gray-900 dark:text-white text-base font-medium leading-normal pb-2"
                            >
                                Start Date *
                            </p>
                            <input
                                id="startDate"
                                name="startDate"
                                type="date"
                                required
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-500 dark:placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal"
                            />
                        </label>
                        <label class="flex flex-col w-full">
                            <p
                                class="text-gray-900 dark:text-white text-base font-medium leading-normal pb-2"
                            >
                                End Date *
                            </p>
                            <input
                                id="endDate"
                                name="endDate"
                                type="date"
                                required
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-500 dark:placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal"
                            />
                        </label>
                    </div>

                    <!-- Duration, Trip Type, Budget -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label class="flex flex-col w-full">
                            <p
                                class="text-gray-900 dark:text-white text-base font-medium leading-normal pb-2"
                            >
                                Duration *
                            </p>
                            <input
                                id="duration"
                                name="duration"
                                required
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-500 dark:placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal"
                                placeholder="e.g., 10 Days"
                            />
                        </label>
                        <label class="flex flex-col w-full">
                            <p
                                class="text-gray-900 dark:text-white text-base font-medium leading-normal pb-2"
                            >
                                Trip Type *
                            </p>
                            <input
                                id="tripType"
                                name="tripType"
                                required
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-500 dark:placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal"
                                placeholder="e.g., Backpacking"
                            />
                        </label>
                        <label class="flex flex-col w-full">
                            <p
                                class="text-gray-900 dark:text-white text-base font-medium leading-normal pb-2"
                            >
                                Budget
                            </p>
                            <input
                                id="budget"
                                name="budget"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-500 dark:placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal"
                                placeholder="e.g., â‚¹50,000"
                            />
                        </label>
                    </div>

                    <!-- Transport -->
                    <label class="flex flex-col w-full">
                        <p
                            class="text-gray-900 dark:text-white text-base font-medium leading-normal pb-2"
                        >
                            Transport
                        </p>
                        <input
                            id="transport"
                            name="transport"
                            class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-500 dark:placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal"
                            placeholder="e.g., Car, Train, Flight"
                        />
                    </label>

                    <!-- Daily Plan -->
                    <div class="flex w-full flex-col gap-4">
                        <p
                            class="text-gray-900 dark:text-white text-base font-medium leading-normal"
                        >
                            Daily Plan *
                        </p>
                        <div id="days-container" class="flex flex-col gap-6">
                            <!-- Days will be added here dynamically -->
                        </div>

                        <button
                            type="button"
                            id="add-day-btn"
                            class="flex min-w-[120px] max-w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base font-bold leading-normal tracking-[0.015em] hover:bg-gray-200 dark:hover:bg-gray-600"
                        >
                            <span class="truncate">Add Another Day</span>
                        </button>
                    </div>

                    <!-- Tags -->
                    <div class="flex w-full flex-col gap-4">
                        <label class="flex flex-col w-full">
                            <p
                                class="text-gray-900 dark:text-white text-base font-medium leading-normal pb-2"
                            >
                                Add Tags
                            </p>
                            <div class="flex gap-2">
                                <input
                                    id="tag-input"
                                    type="text"
                                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-900 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 h-14 placeholder:text-gray-500 dark:placeholder:text-gray-400 p-[15px] text-base font-normal leading-normal"
                                    placeholder="e.g., Jaipur, Heritage, Adventure"
                                />
                                <button
                                    type="button"
                                    id="add-tag-btn"
                                    class="flex items-center justify-center px-6 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg font-medium hover:bg-gray-200 dark:hover:bg-gray-600"
                                >
                                    Add
                                </button>
                            </div>
                        </label>
                        <div id="tags-container" class="flex gap-3 flex-wrap">
                            <!-- Tags will be added here dynamically -->
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-end gap-4 p-4">
                    <button
                        type="button"
                        id="save-draft-btn"
                        class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-base font-bold leading-normal tracking-[0.015em] hover:bg-gray-200 dark:hover:bg-gray-600"
                    >
                        <span class="truncate">Save Draft</span>
                    </button>
                    <button
                        type="submit"
                        id="publish-btn"
                        class="flex min-w-[120px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-6 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary/90"
                    >
                        <span class="truncate">Publish Itinerary</span>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Verification Modal -->
    <VerificationModal />
</Layout>

<script>
    import type { Itinerary, Day, Activity } from "../types/itinerary";

    // State
    let days: Day[] = [];
    let tags: string[] = [];
    let editingId: string | null = null;

    // Helper to generate unique IDs
    function generateId(): string {
        return `${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
    }

    // Toast notification
    function showToast(
        message: string,
        type: "success" | "error" | "info" = "info",
    ): void {
        const toast = document.createElement("div");
        const colors = {
            success: "bg-green-500",
            error: "bg-red-500",
            info: "bg-primary",
        };

        toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = "0";
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
    }

    // Render a single day
    function renderDay(day: Day, index: number): string {
        return `
            <div class="rounded-lg border border-gray-200 dark:border-gray-700 p-4 bg-white dark:bg-gray-800/50" data-day-index="${index}">
                <div class="flex flex-col gap-4">
                    <div class="flex justify-between items-center">
                        <input 
                            type="text" 
                            class="day-title text-lg font-bold text-gray-900 dark:text-white bg-transparent border-0 p-0 focus:ring-0 flex-1"
                            value="Day ${day.dayNumber}: ${day.title || ""}"
                            placeholder="Day ${day.dayNumber}: Enter title"
                        />
                        <button type="button" class="remove-day p-1 text-red-500 hover:text-red-700">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                    <div class="activities-list flex flex-col gap-3 pl-4 border-l-2 border-primary" data-day="${index}">
                        ${day.activities.map((activity, actIndex) => renderActivity(activity, actIndex)).join("")}
                    </div>
                    <button type="button" class="add-activity flex items-center gap-2 text-primary hover:text-primary/80 self-start text-sm font-medium">
                        <span class="material-symbols-outlined text-base">add_circle</span>
                        <span>Add Activity</span>
                    </button>
                </div>
            </div>
        `;
    }

    // Render a single activity
    function renderActivity(activity: Activity, index: number): string {
        return `
            <div class="activity flex flex-col gap-2 p-3 rounded bg-gray-50 dark:bg-gray-700/50" data-activity-index="${index}">
                <div class="flex justify-between items-start gap-2">
                    <input 
                        type="text" 
                        class="activity-title text-base font-semibold leading-normal bg-transparent border-0 p-0 focus:ring-0 text-gray-800 dark:text-gray-200 placeholder:text-gray-500 flex-1"
                        placeholder="Activity Title"
                        value="${activity.title || ""}"
                    />
                    <button type="button" class="remove-activity text-red-500 hover:text-red-700">
                        <span class="material-symbols-outlined text-sm">close</span>
                    </button>
                </div>
                <textarea 
                    class="activity-description form-textarea resize-none bg-transparent border-0 p-0 focus:ring-0 text-gray-600 dark:text-gray-300 placeholder:text-gray-400 text-sm"
                    placeholder="Add a description for this activity..."
                    rows="2"
                >${activity.description || ""}</textarea>
                <div class="grid grid-cols-2 gap-2">
                    <input 
                        type="text" 
                        class="activity-time text-sm bg-transparent border border-gray-200 dark:border-gray-600 rounded p-2 focus:ring-1 focus:ring-primary"
                        placeholder="Time (e.g., 2:00 PM)"
                        value="${activity.time || ""}"
                    />
                    <input 
                        type="text" 
                        class="activity-address text-sm bg-transparent border border-gray-200 dark:border-gray-600 rounded p-2 focus:ring-1 focus:ring-primary"
                        placeholder="Location"
                        value="${activity.address || ""}"
                    />
                </div>
            </div>
        `;
    }

    // Render all days
    function renderDays(): void {
        const container = document.getElementById("days-container");
        if (!container) return;

        container.innerHTML = days
            .map((day, index) => renderDay(day, index))
            .join("");
        attachDayEventListeners();
    }

    // Attach event listeners to days and activities
    function attachDayEventListeners(): void {
        // Remove day buttons
        document.querySelectorAll(".remove-day").forEach((btn, index) => {
            btn.addEventListener("click", () => {
                days.splice(index, 1);
                // Renumber remaining days
                days.forEach((day, i) => (day.dayNumber = i + 1));
                renderDays();
            });
        });

        // Add activity buttons
        document.querySelectorAll(".add-activity").forEach((btn, index) => {
            btn.addEventListener("click", () => {
                days[index].activities.push({ title: "", description: "" });
                renderDays();
            });
        });

        // Remove activity buttons
        document.querySelectorAll(".remove-activity").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const activityEl = (e.target as HTMLElement).closest(
                    ".activity",
                );
                const dayEl = (e.target as HTMLElement).closest(
                    "[data-day-index]",
                );
                if (activityEl && dayEl) {
                    const dayIndex = parseInt(
                        dayEl.getAttribute("data-day-index") || "0",
                    );
                    const activityIndex = parseInt(
                        activityEl.getAttribute("data-activity-index") || "0",
                    );
                    days[dayIndex].activities.splice(activityIndex, 1);
                    renderDays();
                }
            });
        });

        // Update day titles
        document.querySelectorAll(".day-title").forEach((input, index) => {
            input.addEventListener("input", (e) => {
                const value = (e.target as HTMLInputElement).value;
                const match = value.match(/Day \d+:\s*(.*)/);
                if (match) {
                    days[index].title = match[1];
                }
            });
        });

        // Update activity fields
        document.querySelectorAll(".activity-title").forEach((input) => {
            input.addEventListener("input", (e) => {
                const activityEl = (e.target as HTMLElement).closest(
                    ".activity",
                );
                const dayEl = (e.target as HTMLElement).closest(
                    "[data-day-index]",
                );
                if (activityEl && dayEl) {
                    const dayIndex = parseInt(
                        dayEl.getAttribute("data-day-index") || "0",
                    );
                    const activityIndex = parseInt(
                        activityEl.getAttribute("data-activity-index") || "0",
                    );
                    days[dayIndex].activities[activityIndex].title = (
                        e.target as HTMLInputElement
                    ).value;
                }
            });
        });

        document
            .querySelectorAll(".activity-description")
            .forEach((textarea) => {
                textarea.addEventListener("input", (e) => {
                    const activityEl = (e.target as HTMLElement).closest(
                        ".activity",
                    );
                    const dayEl = (e.target as HTMLElement).closest(
                        "[data-day-index]",
                    );
                    if (activityEl && dayEl) {
                        const dayIndex = parseInt(
                            dayEl.getAttribute("data-day-index") || "0",
                        );
                        const activityIndex = parseInt(
                            activityEl.getAttribute("data-activity-index") ||
                                "0",
                        );
                        days[dayIndex].activities[activityIndex].description = (
                            e.target as HTMLTextAreaElement
                        ).value;
                    }
                });
            });

        document.querySelectorAll(".activity-time").forEach((input) => {
            input.addEventListener("input", (e) => {
                const activityEl = (e.target as HTMLElement).closest(
                    ".activity",
                );
                const dayEl = (e.target as HTMLElement).closest(
                    "[data-day-index]",
                );
                if (activityEl && dayEl) {
                    const dayIndex = parseInt(
                        dayEl.getAttribute("data-day-index") || "0",
                    );
                    const activityIndex = parseInt(
                        activityEl.getAttribute("data-activity-index") || "0",
                    );
                    days[dayIndex].activities[activityIndex].time = (
                        e.target as HTMLInputElement
                    ).value;
                }
            });
        });

        document.querySelectorAll(".activity-address").forEach((input) => {
            input.addEventListener("input", (e) => {
                const activityEl = (e.target as HTMLElement).closest(
                    ".activity",
                );
                const dayEl = (e.target as HTMLElement).closest(
                    "[data-day-index]",
                );
                if (activityEl && dayEl) {
                    const dayIndex = parseInt(
                        dayEl.getAttribute("data-day-index") || "0",
                    );
                    const activityIndex = parseInt(
                        activityEl.getAttribute("data-activity-index") || "0",
                    );
                    days[dayIndex].activities[activityIndex].address = (
                        e.target as HTMLInputElement
                    ).value;
                }
            });
        });
    }

    // Render tags
    function renderTags(): void {
        const container = document.getElementById("tags-container");
        if (!container) return;

        container.innerHTML = tags
            .map(
                (tag, index) => `
            <div class="flex h-8 shrink-0 items-center justify-center gap-x-2 rounded-lg bg-gray-100 dark:bg-gray-700 pl-4 pr-3">
                <p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">${tag}</p>
                <button type="button" class="remove-tag cursor-pointer" data-index="${index}">
                    <span class="material-symbols-outlined text-base text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-100">close</span>
                </button>
            </div>
        `,
            )
            .join("");

        // Attach remove listeners
        document.querySelectorAll(".remove-tag").forEach((btn) => {
            btn.addEventListener("click", (e) => {
                const index = parseInt(
                    (e.currentTarget as HTMLElement).getAttribute(
                        "data-index",
                    ) || "0",
                );
                tags.splice(index, 1);
                renderTags();
            });
        });
    }

    // Add day
    document.getElementById("add-day-btn")?.addEventListener("click", () => {
        days.push({
            dayNumber: days.length + 1,
            title: "",
            activities: [],
        });
        renderDays();
    });

    // Add tag
    function addTag(): void {
        const input = document.getElementById("tag-input") as HTMLInputElement;
        if (input && input.value.trim()) {
            const newTags = input.value
                .split(",")
                .map((t) => t.trim())
                .filter((t) => t);
            tags.push(...newTags);
            input.value = "";
            renderTags();
        }
    }

    document.getElementById("add-tag-btn")?.addEventListener("click", addTag);
    document.getElementById("tag-input")?.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            addTag();
        }
    });

    // Save draft to localStorage
    document.getElementById("save-draft-btn")?.addEventListener("click", () => {
        const formData = collectFormData();
        localStorage.setItem("itinerary-draft", JSON.stringify(formData));
        showToast("Draft saved successfully!", "success");
    });

    // Collect form data
    function collectFormData(): any {
        const form = document.getElementById(
            "itinerary-form",
        ) as HTMLFormElement;
        const formData = new FormData(form);

        return {
            title: formData.get("title"),
            summary: formData.get("summary"),
            author: formData.get("author"),
            location: formData.get("location"),
            startDate: formData.get("startDate"),
            endDate: formData.get("endDate"),
            duration: formData.get("duration"),
            tripType: formData.get("tripType"),
            budget: formData.get("budget"),
            transport: formData.get("transport"),
            days: days,
            tags: tags,
        };
    }

    // Submit form
    document
        .getElementById("itinerary-form")
        ?.addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = collectFormData();

            // Validation
            if (days.length === 0) {
                showToast(
                    "Please add at least one day to your itinerary",
                    "error",
                );
                return;
            }

            const now = new Date().toISOString();
            const itinerary: Itinerary = {
                id: editingId || generateId(),
                title: formData.title as string,
                summary: formData.summary as string,
                author: formData.author as string,
                location: formData.location as string,
                startDate: formData.startDate as string,
                endDate: formData.endDate as string,
                duration: formData.duration as string,
                tripType: formData.tripType as string,
                budget: (formData.budget as string) || "",
                transport: (formData.transport as string) || "",
                days: days,
                tags: tags,
                createdAt: editingId
                    ? (await loadExistingItinerary(editingId))?.createdAt || now
                    : now,
                updatedAt: now,
            };

            // Function to submit itinerary to API
            async function submitItinerary() {
                try {
                    const response = await fetch(
                        "/api/itineraries/submit.json",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(itinerary),
                        },
                    );

                    const result = await response.json();

                    if (result.success) {
                        showToast(
                            "Itinerary published successfully!",
                            "success",
                        );
                        localStorage.removeItem("itinerary-draft");
                        setTimeout(() => {
                            window.location.href = `/itinerary/${result.id}`;
                        }, 1500);
                    } else if (response.status === 401) {
                        // Not authenticated - show verification modal
                        if (
                            typeof (window as any).initVerificationModal ===
                            "function"
                        ) {
                            const modal = (window as any).initVerificationModal(
                                (email: string) => {
                                    // After successful verification, the session cookie is set
                                    // We need to wait a moment then reload/resubmit
                                    showToast(
                                        "Email verified! You can now publish your itinerary.",
                                        "success",
                                    );
                                    // Save form data to localStorage so it persists after reload
                                    localStorage.setItem(
                                        "verified-submission",
                                        JSON.stringify(itinerary),
                                    );
                                    // Reload to pick up the session cookie
                                    window.location.reload();
                                },
                            );
                            modal.showModal();
                        } else {
                            showToast(
                                "Please refresh the page and try again",
                                "error",
                            );
                        }
                    } else {
                        showToast(
                            result.message || "Failed to publish itinerary",
                            "error",
                        );
                    }
                } catch (error) {
                    console.error("Error:", error);
                    showToast("An error occurred while publishing", "error");
                }
            }

            // Try to submit (will trigger auth flow if needed)
            await submitItinerary();
        });

    // Load existing itinerary for editing
    async function loadExistingItinerary(
        id: string,
    ): Promise<Itinerary | null> {
        try {
            const response = await fetch(`/data/itineraries/${id}.json`);
            if (response.ok) {
                return await response.json();
            }
        } catch (error) {
            console.error("Error loading itinerary:", error);
        }
        return null;
    }

    // Initialize
    async function init(): Promise<void> {
        // Check if editing
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get("id");

        if (id) {
            editingId = id;
            const existing = await loadExistingItinerary(id);
            if (existing) {
                // Populate form
                (document.getElementById("title") as HTMLInputElement).value =
                    existing.title;
                (
                    document.getElementById("summary") as HTMLTextAreaElement
                ).value = existing.summary;
                (document.getElementById("author") as HTMLInputElement).value =
                    existing.author;
                (
                    document.getElementById("location") as HTMLInputElement
                ).value = existing.location;
                (
                    document.getElementById("startDate") as HTMLInputElement
                ).value = existing.startDate;
                (document.getElementById("endDate") as HTMLInputElement).value =
                    existing.endDate;
                (
                    document.getElementById("duration") as HTMLInputElement
                ).value = existing.duration;
                (
                    document.getElementById("tripType") as HTMLInputElement
                ).value = existing.tripType;
                (document.getElementById("budget") as HTMLInputElement).value =
                    existing.budget || "";
                (
                    document.getElementById("transport") as HTMLInputElement
                ).value = existing.transport || "";

                days = existing.days;
                tags = existing.tags;

                renderDays();
                renderTags();
                return;
            }
        }

        // Check for draft
        const draft = localStorage.getItem("itinerary-draft");
        if (draft && !id) {
            const confirmed = confirm(
                "A draft was found. Would you like to continue from where you left off?",
            );
            if (confirmed) {
                const draftData = JSON.parse(draft);
                (document.getElementById("title") as HTMLInputElement).value =
                    draftData.title || "";
                (
                    document.getElementById("summary") as HTMLTextAreaElement
                ).value = draftData.summary || "";
                (document.getElementById("author") as HTMLInputElement).value =
                    draftData.author || "";
                (
                    document.getElementById("location") as HTMLInputElement
                ).value = draftData.location || "";
                (
                    document.getElementById("startDate") as HTMLInputElement
                ).value = draftData.startDate || "";
                (document.getElementById("endDate") as HTMLInputElement).value =
                    draftData.endDate || "";
                (
                    document.getElementById("duration") as HTMLInputElement
                ).value = draftData.duration || "";
                (
                    document.getElementById("tripType") as HTMLInputElement
                ).value = draftData.tripType || "";
                (document.getElementById("budget") as HTMLInputElement).value =
                    draftData.budget || "";
                (
                    document.getElementById("transport") as HTMLInputElement
                ).value = draftData.transport || "";

                days = draftData.days || [];
                tags = draftData.tags || [];
            }
        }

        // Initialize with one day if empty
        if (days.length === 0) {
            days.push({
                dayNumber: 1,
                title: "",
                activities: [{ title: "", description: "" }],
            });
        }

        renderDays();
        renderTags();
    }

    init();

    // Check if we just verified and need to submit
    const verifiedSubmission = localStorage.getItem("verified-submission");
    if (verifiedSubmission) {
        localStorage.removeItem("verified-submission");
        // Auto-submit the verified itinerary
        setTimeout(async () => {
            try {
                const itineraryData = JSON.parse(verifiedSubmission);
                const response = await fetch("/api/itineraries/submit.json", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(itineraryData),
                });

                const result = await response.json();

                if (result.success) {
                    showToast("Itinerary published successfully!", "success");
                    localStorage.removeItem("itinerary-draft");
                    setTimeout(() => {
                        window.location.href = `/itinerary/${result.id}`;
                    }, 1500);
                } else {
                    showToast(
                        result.message || "Failed to publish itinerary",
                        "error",
                    );
                }
            } catch (error) {
                console.error("Error:", error);
                showToast("An error occurred while publishing", "error");
            }
        }, 500);
    }
</script>
